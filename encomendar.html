<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <title>Encomendar - Mercúrio</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="icon" href="images/favicon.ico">
  <link rel="shortcut icon" href="images/favicon.ico">
  <style>
    /* --------------- CSS -------------- */
    /* RESET E ESTILOS GERAIS */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
    }
    
    .clear {
      clear: both;
    }
    
    /* CABEÇALHO */
    header {
      background-color: #333;
      color: white;
      padding: 15px 0;
      position: relative;
    }
    
    .container_12 {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    
    .titulo-principal {
      font-size: 2em;
      margin: 10px 0;
      padding-right: 50px;
    }
    
    .color1 { color: #f0a500; }
    .color0 { color: white; }
    
    /* MENU PRINCIPAL */
    .sf-menu {
      display: flex;
      list-style: none;
      margin: 15px 0 0 0;
      padding: 0;
    }
    
    .sf-menu li {
      margin: 0 10px;
    }
    
    .sf-menu a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      display: block;
      transition: all 0.3s;
    }
    
    .sf-menu a:hover {
      background-color: #f0a500;
      color: #333;
    }

    .sf-menu .current a {
      background-color: #f0a500;
      color: #333;
    }
    
    /* BOTÃO MENU MOBILE */
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      position: absolute;
      right: 20px;
      top: 20px;
      z-index: 1000;
    }
    
    /* CONTEÚDO PRINCIPAL */
    .content {
      padding: 30px 0;
    }
    
    h5, h6 {
      margin: 15px 0;
      color: #333;
    }
    
    h5 {
      font-size: 1.2em;
    }
    
    h6 {
      font-size: 1em;
      font-weight: bold;
    }
    
    /* FORMULÁRIO */
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    input[type="radio"] {
      margin-right: 5px;
    }
    
    .address-section {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    /* BOTÕES */
    .btn2, .btn3 {
      display: inline-block;
      padding: 10px 20px;
      background-color: #1b6222;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 0;
      transition: background-color 0.3s;
    }
    
    .btn2:hover, .btn3:hover {
      background-color: #f0a500;
    }
    
    /* ESTOQUE */
    #estoqueMesas, #estoqueCadeiras, #estoqueBancos {
      margin: 5px 0;
    }
    
    /* MODAL */
    #fade {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 5;
    }
    
    #modal {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 500px;
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      z-index: 10;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    /* RODAPÉ */
    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 30px 0;
      margin-top: 30px;
    }
    
    .socials a {
      color: white;
      margin: 0 10px;
      font-size: 1.5em;
    }
    
    /* RESPONSIVIDADE */
    @media (max-width: 768px) {
      /* MENU MOBILE */
      .menu-toggle {
        display: block;
      }
      
      .sf-menu {
        display: none;
        flex-direction: column;
        width: 100%;
        background-color: #444;
        position: absolute;
        top: 80px;
        left: 0;
        padding: 20px 0;
        margin-top: 0;
      }
      
      .sf-menu.active {
        display: flex;
      }
      
      .sf-menu li {
        margin: 5px 0;
        text-align: center;
      }
      
      /* TÍTULO */
      .titulo-principal {
        font-size: 1.5em;
        padding-right: 0;
      }
      
      /* FORMULÁRIO */
      .radio-group {
        display: flex;
        flex-direction: column;
      }
      
      input[type="radio"] {
        margin: 5px 0;
      }
    }
    
    @media (max-width: 480px) {
      .titulo-principal {
        font-size: 1.3em;
      }
      
      .btn2, .btn3 {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!---------------- HTML --------------->
  <!-- CABEÇALHO -->
  <header>
    <div class="container_12">
      <button class="menu-toggle" id="menuToggle">☰</button>
      
      <h1 class="titulo-principal">
        <span class="color1">MERCÚRIO </span>
        <span class="color0">Seu Espaço, Nosso Mobiliário</span>
      </h1>
      
      <nav id="mainNav">
        <ul class="sf-menu">
          <li><a href="index.html">Início</a></li>
          <li><a href="customer_area.html">Usuário identificado</a></li>
          <li class="current"><a href="encomendar.html">Encomendar</a></li>
          <li><a href="index-2.html">Produtos</a></li>
          <li><a href="eventos.html">Eventos</a></li>
          <li><a href="index-3.html">Serviços</a></li>
          <li><a href="index-4.html">Contatos</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- CONTEÚDO PRINCIPAL -->
  <div class="content">
    <div class="container_12">
      <h5>Precisa de mesas e cadeiras para seu evento? <br>Faça já o seu pedido:</h5>

      <!-- Controle de Estoque -->
      <div style="margin-top: 20px;">
        <h4>Estoque Disponível</h4>
        <p id="estoqueMesas">Mesas: </p>
        <p id="estoqueCadeiras">Cadeiras: </p>
        <p id="estoqueBancos">Bancos: </p>
      </div>

      <h6>Para qual data você vai precisar?</h6>
      <input type="text" id="datepickerstart" placeholder="Data de Início (dd/mm/aaaa)">
      
      <h6>Data de devolução</h6>
      <input type="text" id="datepickerend" placeholder="Data de Retorno (dd/mm/aaaa)">

      <h6>Escolha o modelo:</h6>
      <div class="radio-group">
        <label><input type="radio" name="opcao" id="conforto" value="1" onclick="change1()"> CONFORTO</label>
        <label><input type="radio" name="opcao" id="medio" value="2" onclick="change2()"> MÉDIO</label>
        <label><input type="radio" name="opcao" id="executivo" value="3" onclick="change3()"> EXECUTIVO</label>
      </div>
      
      <div id="change" style="margin: 15px 0;"></div>
      
      <h6>Escolha a quantidade de bancos:</h6>
      <input type="number" id="quantidadebancos" name="quantidadebancos" min="0" max="50" value="0"> 
      <span>R$<span id="resbancos">--</span></span>
      
      <h6>Escolha a quantidade de cadeiras:</h6>
      <input type="number" id="quantidadecadeiras" name="quantidadecadeiras" min="0" max="200" value="0"> 
      <span>R$<span id="rescadeiras">--</span></span>
      
      <h6>Escolha a quantidade de mesas:</h6>
      <input type="number" id="quantidademesas" name="quantidademesas" min="0" max="50" value="0"> 
      <span>R$<span id="resmesas">--</span></span>
      
      <div style="margin: 20px 0;">
        <p><b>VALOR DIÁRIA: R$ <span id="totaldiaria">0.00</span></b></p>
        <p><b>VALOR TOTAL (SEM FRETE): R$ <span id="totalpedido_frete">0.00</span></b></p>
        <p id="frete-section" style="display: none;"><b>FRETE: R$ <span id="valor_frete">0.00</span></b></p>
        <p><b>VALOR TOTAL (COM FRETE): R$ <span id="totalpedido">0.00</span></b></p>
      </div>
      
      <button type="button" class="btn3" id="btn3" onclick="valor()">Calcular Total</button>

      <!-- Nova seção para escolha de entrega/retirada -->
      <h6>Forma de recebimento:</h6>
      <div class="radio-group">
        <label><input type="radio" name="entrega" id="retirada" value="retirada" checked onclick="toggleAddress(false)"> Retirar na loja</label>
        <label><input type="radio" name="entrega" id="entrega" value="entrega" onclick="toggleAddress(true)"> Receber em casa</label>
      </div>

      <!-- Seção de endereço (aparece apenas quando "Receber em casa" está selecionado) -->
      <div id="address-section" style="display: none;">
        <h6>Endereço de entrega:</h6>
        <div class="radio-group">
          <label><input type="radio" name="endereco_opcao" id="endereco_cadastrado" value="cadastrado" checked onclick="toggleAddressFields(false)"> Usar endereço cadastrado</label>
          <label><input type="radio" name="endereco_opcao" id="endereco_novo" value="novo" onclick="toggleAddressFields(true)"> Usar novo endereço</label>
        </div>

        <!-- Campos para novo endereço (aparecem apenas quando "Usar novo endereço" está selecionado) -->
        <div id="novo-endereco-section" class="address-section">
          <h6>Novo endereço:</h6>
          <input type="text" id="novo-cep" maxlength="9" placeholder="CEP (00000-000)" onblur="buscarCEP()">
          <button type="button" class="btn3" onclick="buscarCEP()">Buscar CEP</button>
          <input type="text" id="novo-rua" placeholder="Rua">
          <input type="text" id="novo-numero" placeholder="Número">
          <input type="text" id="novo-complemento" placeholder="Complemento">
          <input type="text" id="novo-bairro" placeholder="Bairro">
          <input type="text" id="novo-cidade" placeholder="Cidade">
          <input type="text" id="novo-estado" placeholder="Estado" maxlength="2">
        </div>
      </div>

      <div id="loja-info" style="margin: 15px 0; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
        <h6>Endereço para retirada:</h6>
        <p>Av. Independência, 5110 - Barra Funda, Vinhedo - SP, 13280-000</p>
      </div>
      
      <button id="open-modal" class="btn2" onclick="fim()">Finalizar Pedido</button>
      
      <!-- MODAL DE CONFIRMAÇÃO -->
      <div id="fade"></div>
      <div id="modal">
        <div class="modal-header" id="titulo">
          <h5>Pedidos</h5>
          <button id="close-modal" class="btn2">Fechar</button>
        </div>
        <div class="modal-body" id="corpo">
          Preencha todas as informações para que seu pedido seja concluído. 
          <br>Em caso de dúvidas entre em contato pelo Whatsapp.
        </div>
      </div>
    </div>
  </div>

  <!-- RODAPÉ -->
  <footer>
    <div class="container_12">
      <div style="margin-bottom: 20px;">
        <i class="fa fa-phone"></i> <span>Ligue para nós:</span> 19 99999-5555
      </div>
      
      <div class="socials" style="margin-bottom: 20px;">
        <a href="https://api.whatsapp.com/" class="fa fa-whatsapp"></a>
        <a href="https://www.facebook.com/" class="fa fa-facebook"></a>
        <a href="https://www.instagram.com/" class="fa fa-instagram"></a>
        <a href="https://twitter.com/" class="fa fa-twitter"></a>
      </div>
      
      <div>
        <div style="margin-bottom: 10px;">
          <span style="font-weight: bold; color: #f0a500;">MERCÚRIO</span>
          &copy; 2025 | <a href="#" style="color: #f0a500;">Política de Privacidade</a>
        </div>
        <div>
          <a href="group-members.html" style="color: #aaa; font-size: 0.8em;">Site desenvolvido por DRP04-PJI310-SALA-004GRUPO-009 - PROJETO INTEGRADOR III - UNIVESP</a>
        </div>
      </div>
    </div>
  </footer>
<!------------- JAVASCRIPT ------------>
 <script>

  // URL do Google Apps Script
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPrh-Rr9r-RXRZjYmOn_0FDZi7kAflYGjn3pVrx02vKeRo9MLjTxtOGAR4ovSTiU9-/exec";

  //INICIANDO DADOS
   let dados = {};
  // CONTROLE DO MENU MOBILE
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('menuToggle');
    const mainNav = document.querySelector('.sf-menu');
    
    if (window.innerWidth <= 768) {
      mainNav.style.display = 'none';
    }
    
    menuToggle.addEventListener('click', function() {
      if (mainNav.style.display === 'none' || mainNav.style.display === '') {
        mainNav.style.display = 'flex';
      } else {
        mainNav.style.display = 'none';
      }
    });
    
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        mainNav.style.display = 'flex';
      } else {
        mainNav.style.display = 'none';
      }
    });

    // Datepicker
    $("#datepickerstart").datepicker({
      dateFormat: "dd/mm/yy",
      minDate: 0,
      onSelect: function() {
        let startDate = $("#datepickerstart").datepicker("getDate");
        startDate.setDate(startDate.getDate() + 1);
        $("#datepickerend").datepicker("option", "minDate", startDate);
      }
    });
    
    $("#datepickerend").datepicker({
      dateFormat: "dd/mm/yy",
      minDate: 1
    });
    
   carregarEstoque();
    
    const closeModalBtn = document.getElementById("close-modal");
    closeModalBtn.addEventListener("click", () => {
      document.getElementById("fade").style.display = "none";
      document.getElementById("modal").style.display = "none";
      window.location.href = "customer_area.html";
    }); 

    toggleAddress(false);
  });

  // FUNÇÕES DE CONTROLE DE ENDEREÇO
  function toggleAddress(show) {
    document.getElementById('address-section').style.display = show ? 'block' : 'none';
    document.getElementById('loja-info').style.display = show ? 'none' : 'block';
    document.getElementById('frete-section').style.display = show ? 'block' : 'none';
    if (!show) {
      toggleAddressFields(false);
    }
  }

  // CONTROLE DE ENDEREÇO
  function toggleAddress(show) {
    document.getElementById('address-section').style.display = show ? 'block' : 'none';
    document.getElementById('loja-info').style.display = show ? 'none' : 'block';
    document.getElementById('frete-section').style.display = show ? 'block' : 'none';
    
    if (show) {
      carregarEnderecoCadastrado();
    } else {
      toggleAddressFields(false);
    }
  }
  
  // FUNÇÃO NOVO ENDEREÇO
  function toggleAddressFields(show) {
    document.getElementById('novo-endereco-section').style.display = show ? 'block' : 'none';
  }
  
  async function carregarEnderecoCadastrado() {
    try {
      const userData = JSON.parse(localStorage.getItem("userData"));
      if (!userData || !userData.email) {
        console.log("Usuário não logado ou dados incompletos");
        return;
      }
  
      const response = await fetch(`${SCRIPT_URL}?action=getUserData&email=${encodeURIComponent(userData.email)}`);
      const result = await response.json();
  
      if (result.status === "success") {
        const endereco = result.data.endereco;
        const enderecoCadastradoDiv = document.getElementById('endereco-cadastrado-display') || 
            document.createElement('div');
        enderecoCadastradoDiv.id = 'endereco-cadastrado-display';
        enderecoCadastradoDiv.className = 'address-display';
        
        enderecoCadastradoDiv.innerHTML = `
          <p><strong>Endereço Cadastrado:</strong></p>
          <p>${endereco.rua}, ${endereco.numero}${endereco.complemento ? ' - ' + endereco.complemento : ''}</p>
          <p>${endereco.bairro}, ${endereco.cidade} - ${endereco.estado}</p>
          <p>CEP: ${endereco.cep}</p>
        `;
        
        const enderecoCadastradoLabel = document.getElementById('endereco_cadastrado').parentNode;
        enderecoCadastradoLabel.parentNode.insertBefore(
          enderecoCadastradoDiv, 
          enderecoCadastradoLabel.nextSibling
        );
      }
    } catch (error) {
      console.error("Erro ao carregar endereço:", error);
    }
  }
  

  // BUSCA CEP
  function buscarCEP() {
    const cep = document.getElementById('novo-cep').value.replace(/\D/g, '');
    
    if (cep.length !== 8) {
      alert('CEP inválido. Digite os 8 números do CEP');
      return;
    }
    
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(response => response.json())
      .then(data => {
        if (data.erro) {
          alert('CEP não encontrado!');
          return;
        }
        
        document.getElementById('novo-rua').value = data.logradouro || '';
        document.getElementById('novo-bairro').value = data.bairro || '';
        document.getElementById('novo-cidade').value = data.localidade || '';
        document.getElementById('novo-estado').value = data.uf || '';
        document.getElementById('novo-numero').focus();
      })
      .catch(error => {
        console.error('Erro ao buscar CEP:', error);
        alert('Erro ao buscar CEP. Tente novamente mais tarde.');
      });
  }

  // FUNÇÕES DE EXIBIÇÃO DOS MODELOS
  function change1() {
    document.getElementById("change").innerHTML = 
      "<img src='images/page1_img1.jpg' style='max-width:100%;height:auto;'><br>" +
      "<b>CONFORTO</b><br>Mesa R$15,00 /dia<br>Cadeira R$5,00 /dia<br>Banco R$3,00 /dia";
  }

  function change2() {
    document.getElementById("change").innerHTML = 
      "<img src='images/page1_img2.jpg' style='max-width:100%;height:auto;'><br>" +
      "<b>MÉDIO</b><br>Mesa R$25,00 /dia<br>Cadeira R$8,00 /dia<br>Banco R$5,00 /dia";
  }

  function change3() {
    document.getElementById("change").innerHTML = 
      "<img src='images/page1_img3.jpg' style='max-width:100%;height:auto;'><br>" +
      "<b>EXECUTIVO</b><br>Mesa R$40,00 /dia<br>Cadeira R$12,00 /dia<br>Banco R$8,00 /dia";
  }

  // FUNÇÃO DE CÁLCULO DO VALOR TOTAL
  function valor() {
    const startDate = $("#datepickerstart").datepicker("getDate");
    const endDate = $("#datepickerend").datepicker("getDate");
    
    if (!startDate || !endDate) {
      alert("Por favor, selecione as datas de início e término");
      return;
    }

    const diffTime = Math.abs(endDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const bancos = parseInt(document.getElementById("quantidadebancos").value) || 0;
    const cadeiras = parseInt(document.getElementById("quantidadecadeiras").value) || 0;
    const mesas = parseInt(document.getElementById("quantidademesas").value) || 0;
    
    let valorBanco, valorCadeira, valorMesa;
    
    if (document.getElementById("conforto").checked) {
      valorBanco = 3;
      valorCadeira = 5;
      valorMesa = 15;
    } else if (document.getElementById("medio").checked) {
      valorBanco = 5;
      valorCadeira = 8;
      valorMesa = 25;
    } else if (document.getElementById("executivo").checked) {
      valorBanco = 8;
      valorCadeira = 12;
      valorMesa = 40;
    } else {
      alert("Por favor, selecione um modelo");
      return;
    }
    
    const totalBancos = bancos * valorBanco * diffDays;
    const totalCadeiras = cadeiras * valorCadeira * diffDays;
    const totalMesas = mesas * valorMesa * diffDays;
    
    document.getElementById("resbancos").innerHTML = totalBancos.toFixed(2);
    document.getElementById("rescadeiras").innerHTML = totalCadeiras.toFixed(2);
    document.getElementById("resmesas").innerHTML = totalMesas.toFixed(2);
    
    const totalDiaria = (bancos * valorBanco) + (cadeiras * valorCadeira) + (mesas * valorMesa);
    const totalSemFrete = totalBancos + totalCadeiras + totalMesas;
    
    document.getElementById("totaldiaria").innerHTML = totalDiaria.toFixed(2);
    document.getElementById("totalpedido_frete").innerHTML = totalSemFrete.toFixed(2);
    
    if (document.getElementById('retirada').checked) {
      document.getElementById("frete-section").style.display = "none";
      document.getElementById("totalpedido").innerHTML = totalSemFrete.toFixed(2);
    } else {
      document.getElementById("frete-section").style.display = "block";
      calcularFrete(totalSemFrete);
    }
  }

  // FUNÇÃO PARA CALCULAR FRETE
  function calcularFrete(totalSemFrete) {
    const isEntrega = document.getElementById('entrega').checked;
    
    if (!isEntrega) {
      document.getElementById("valor_frete").innerHTML = "0.00";
      document.getElementById("totalpedido").innerHTML = totalSemFrete.toFixed(2);
      return;
    }
    
    const usarEnderecoCadastrado = document.getElementById('endereco_cadastrado').checked;
    let cep = '';
    
    if (usarEnderecoCadastrado) {
      const loggedInUserEmail = localStorage.getItem('loggedInUser');
      if (loggedInUserEmail) {
        const userData = JSON.parse(localStorage.getItem(loggedInUserEmail));
        if (userData && userData.cep) {
          cep = userData.cep.replace(/\D/g, '');
        }
      }
    } else {
      cep = document.getElementById('novo-cep').value.replace(/\D/g, '');
    }
    
    if (!cep || cep.length !== 8) {
      const fretePadrao = 50.00;
      document.getElementById("valor_frete").innerHTML = fretePadrao.toFixed(2);
      document.getElementById("totalpedido").innerHTML = (totalSemFrete + fretePadrao).toFixed(2);
      return;
    }
    
    const frete = Math.floor(Math.random() * 50) + 20;
    document.getElementById("valor_frete").innerHTML = frete.toFixed(2);
    document.getElementById("totalpedido").innerHTML = (totalSemFrete + frete).toFixed(2);
  }


// FUNÇÃO PARA BUSCAR O ESTOQUE (BACKEND)
async function obterEstoque() {
  try {
    const response = await fetch('https://locacao-backend-mercurio.onrender.com/api/estoque');
    const estoque = await response.json();
    if (response.ok) {
      // Exibe o estoque na interface
      document.getElementById('estoqueMesas').innerText = `Mesas: ${estoque.estoqueMesas}`;
      document.getElementById('estoqueCadeiras').innerText = `Cadeiras: ${estoque.estoqueCadeiras}`;
      document.getElementById('estoqueBancos').innerText = `Bancos: ${estoque.estoqueBancos}`;
    } else {
      alert('Erro ao obter estoque');
    }
  } catch (error) {
    console.error('Erro ao buscar estoque:', error);
    alert('Erro ao conectar com o backend');
  }
} 

//CARREGAMENTO DE DADOS NO INÍCIO
async function carregarEstoque() {
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getStock`);
        const result = await response.json();
        
        if (result.status === "success") {
            dados = {
                estoquemesas: result.mesas || 0,
                estoquecadeiras: result.cadeiras || 0,
                estoquebancos: result.bancos || 0
            };
            
            document.getElementById('estoqueMesas').innerHTML = `Mesas: ${dados.estoquemesas}`;
            document.getElementById('estoqueCadeiras').innerHTML = `Cadeiras: ${dados.estoquecadeiras}`;
            document.getElementById('estoqueBancos').innerHTML = `Bancos: ${dados.estoquebancos}`;
        } else {
            throw new Error(result.message || "Erro ao carregar estoque");
        }
    } catch (error) {
        console.error('Erro ao carregar estoque:', error);
        // Pode adicionar um fallback aqui se necessário
    }
}

// Chamar carregarEstoque antes de usar dados em outras funções
document.addEventListener('DOMContentLoaded', carregarEstoque);
   
  // FUNÇÃO DE ENVIO DOS DADOS DO PEDIDO PARA O BACKEND
async function criarPedido(pedido) {
  try {
    const response = await fetch('https://locacao-backend-mercurio.onrender.com/api/pedidos', {
      method: 'POST', 
      headers: {
        'Content-Type': 'application/json', 
      },
      body: JSON.stringify(pedido), 
    });

    const data = await response.json();
    if (response.ok) {
      alert('Pedido criado com sucesso! ID: ' + data.pedidoId);
    } else {
      alert('Erro ao criar pedido: ' + data.message);
    }
  } catch (error) {
    console.error('Erro de comunicação com o backend:', error);
    alert('Erro ao enviar pedido');
  }
}

   window.onload = carregarEstoque;

   async function fim() {
      try {
          // 1. Desabilita o botão para evitar múltiplos cliques
          const btnFinalizar = document.getElementById('open-modal');
          btnFinalizar.disabled = true;
          btnFinalizar.textContent = 'Processando...';
  
          // 2. Validação dos campos obrigatórios
          const requiredFields = ['datepickerstart', 'datepickerend', 'quantidadebancos', 'quantidadecadeiras', 'quantidademesas'];
          for (const fieldId of requiredFields) {
              const field = document.getElementById(fieldId);
              if (!field.value || parseInt(field.value) < 0) {
                  throw new Error(`Por favor, preencha o campo ${fieldId.replace('-', ' ')}`);
              }
          }
  
          // 3. Verifica se o estoque foi carregado
          if (!dados) {
              throw new Error('Estoque não carregado ainda. Tente novamente.');
          }
  
          // 4. Verifica se um modelo foi selecionado
          if (!document.querySelector('input[name="opcao"]:checked')) {
              throw new Error("Por favor, selecione um modelo");
          }
  
          // 5. Obtém as quantidades dos itens
          const bancos = parseInt(document.getElementById("quantidadebancos").value);
          const cadeiras = parseInt(document.getElementById("quantidadecadeiras").value);
          const mesas = parseInt(document.getElementById("quantidademesas").value);
  
          // 6. Verifica o estoque ANTES de prosseguir
          if (bancos > dados.estoquebancos) {
              throw new Error(`Quantidade de bancos indisponível (estoque: ${dados.estoquebancos})`);
          }
          if (cadeiras > dados.estoquecadeiras) {
              throw new Error(`Quantidade de cadeiras indisponível (estoque: ${dados.estoquecadeiras})`);
          }
          if (mesas > dados.estoquemesas) {
              throw new Error(`Quantidade de mesas indisponível (estoque: ${dados.estoquemesas})`);
          }
  
          // 7. Processamento do endereço
          const isEntrega = document.getElementById('entrega').checked;
          let enderecoEntrega = '';
          let tipoEntrega = isEntrega ? 'Entrega' : 'Retirada';
  
          if (isEntrega) {
              const usarEnderecoCadastrado = document.getElementById('endereco_cadastrado').checked;
              
              if (usarEnderecoCadastrado) {
                  // Usa endereço cadastrado
                  const userData = JSON.parse(localStorage.getItem("userData"));
                  if (!userData || !userData.email) {
                      throw new Error('Você precisa estar logado para usar o endereço cadastrado');
                  }
  
                  // Busca endereço no Google Sheets
                  const response = await fetch(`${SCRIPT_URL}?action=getUserData&email=${encodeURIComponent(userData.email)}`);
                  const result = await response.json();
  
                  if (result.status === "success" && result.data.endereco) {
                      const end = result.data.endereco;
                      enderecoEntrega = `${end.rua}, ${end.numero || 'S/N'}${end.complemento ? ' - ' + end.complemento : ''}, ${end.bairro}, ${end.cidade} - ${end.estado}, CEP: ${end.cep}`;
                  } else {
                      throw new Error('Endereço cadastrado não encontrado ou incompleto');
                  }
              } else {
                  // Usa novo endereço
                  const novoCep = document.getElementById('novo-cep').value;
                  const novoRua = document.getElementById('novo-rua').value;
                  const novoNumero = document.getElementById('novo-numero').value;
                  const novoCidade = document.getElementById('novo-cidade').value;
                  const novoEstado = document.getElementById('novo-estado').value;
                  
                  if (!novoCep || !novoRua || !novoNumero || !novoCidade || !novoEstado) {
                      throw new Error('Por favor, preencha todos os campos do endereço');
                  }
                  
                  enderecoEntrega = `${novoRua}, ${novoNumero}${document.getElementById('novo-complemento').value ? ' - ' + document.getElementById('novo-complemento').value : ''}, ${document.getElementById('novo-bairro').value}, ${novoCidade} - ${novoEstado}, CEP: ${novoCep}`;
              }
          } else {
              // Endereço para retirada
              enderecoEntrega = 'Av. Independência, 5110 - Barra Funda, Vinhedo - SP, 13280-000 (Retirada na loja)';
          }
  
          // 8. Cálculo das datas e período
          const startDate = $("#datepickerstart").datepicker("getDate");
          const endDate = $("#datepickerend").datepicker("getDate");
          const dias = Math.ceil(Math.abs(endDate - startDate) / (1000 * 60 * 60 * 24));
  
          // 9. Obtém o modelo selecionado
          const modeloRadio = document.querySelector('input[name="opcao"]:checked').value;
          const modelo = modeloRadio === "1" ? "Conforto" : modeloRadio === "2" ? "Médio" : "Executivo";
  
          // 10. Obtém os valores totais
          const totalDiario = parseFloat(document.getElementById("totaldiaria").innerHTML);
          const totalSemFrete = parseFloat(document.getElementById("totalpedido_frete").innerHTML);
          const frete = isEntrega ? parseFloat(document.getElementById("valor_frete").innerHTML) : 0;
          const total = parseFloat(document.getElementById("totalpedido").innerHTML);
  
          // 11. Monta os dados para envio na ORDEM CORRETA DA PLANILHA
          const formData = new URLSearchParams();
          formData.append('usuario', JSON.parse(localStorage.getItem("userData"))?.nomeUsuario || "Não identificado");
          
          const now = new Date();
          const dataPedidoBr = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
          formData.append('data_pedido', dataPedidoBr);
          
          const userData = JSON.parse(localStorage.getItem("userData")) || {};
          const nomeCompleto = `${userData.nome || ''} ${userData.sobrenome || ''}`.trim() || "Cliente não identificado";
          formData.append('nome', nomeCompleto);
          
          formData.append('email', userData.email || "sem-email@example.com");
          formData.append('data_inicio', startDate.toLocaleDateString('pt-BR'));
          formData.append('data_fim', endDate.toLocaleDateString('pt-BR'));
          formData.append('cadeiras', cadeiras.toString());
          formData.append('bancos', bancos.toString());
          formData.append('mesas', mesas.toString());
          formData.append('endereco', enderecoEntrega);
          formData.append('valor_total', total.toFixed(2));
          formData.append('status', "Confirmado");
          formData.append('modelo', modelo);
          formData.append('periodo', `${dias} dias`);
          formData.append('tipo_entrega', tipoEntrega);
          formData.append('observacoes', "Pedido criado via site");
          formData.append('action', 'save_order');
  
          // 12. Envia para o Google Sheets
          const sheetsResponse = await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: formData
          });
          
          const result = await sheetsResponse.json();
          
          if (result.status !== "success") {
              throw new Error("Erro ao salvar na planilha: " + (result.message || ""));
          }
  
          // 13. ATUALIZAÇÃO DO ESTOQUE VIA GOOGLE APPS SCRIPT
          const estoqueAtualizado = {
              mesas: dados.estoquemesas - mesas,
              cadeiras: dados.estoquecadeiras - cadeiras,
              bancos: dados.estoquebancos - bancos,
              action: 'updateStock' // Nova ação
          };
  
          const estoqueResponse = await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams(estoqueAtualizado)
          });
  
          const estoqueResult = await estoqueResponse.json();
          
          if (estoqueResult.status !== "success") {
              throw new Error("Pedido criado, mas erro ao atualizar estoque. Contate o suporte.");
          }
  
          // Atualiza o estoque localmente
          dados.estoquemesas -= mesas;
          dados.estoquecadeiras -= cadeiras;
          dados.estoquebancos -= bancos;
          
          document.getElementById('estoqueMesas').innerHTML = `Mesas: ${dados.estoquemesas}`;
          document.getElementById('estoqueCadeiras').innerHTML = `Cadeiras: ${dados.estoquecadeiras}`;
          document.getElementById('estoqueBancos').innerHTML = `Bancos: ${dados.estoquebancos}`;
  
          // ... (restante do código permanece igual)
      } catch (error) {
          console.error("Erro ao finalizar pedido:", error);
          alert(`Erro ao processar pedido: ${error.message}`);
      } finally {
          const btnFinalizar = document.getElementById('open-modal');
          if (btnFinalizar) {
              btnFinalizar.disabled = false;
              btnFinalizar.textContent = 'Finalizar Pedido';
          }
      }
  }

  function formatarData(dataString) {
  const [ano, mes, dia] = dataString.split('-');
  return `${dia}/${mes}/${ano}`;
  }
   
  async function salvarPedido(pedidoData) {
  const response = await fetch(SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      action: 'save_order',
      usuario: pedidoData.usuario,
      nome: pedidoData.nome,
      email: pedidoData.email,
      data_inicio: pedidoData.data_inicio,
      data_fim: pedidoData.data_fim,
      cadeiras: pedidoData.cadeiras,
      bancos: pedidoData.bancos,
      mesas: pedidoData.mesas,
      endereco: pedidoData.endereco,
      valor_total: pedidoData.valor_total,
      status: pedidoData.status,
      modelo: pedidoData.modelo,
      periodo: pedidoData.periodo,
      tipo_entrega: pedidoData.tipo_entrega,
      observacoes: pedidoData.observacoes
    })
  });
  
  return await response.json();
}

  async function getPedidosCliente(email) {
    const response = await fetch(`${SCRIPT_URL}?action=get_user_orders&email=${encodeURIComponent(email)}`);
    return await response.json();
  }
  </script>
</body>
</html>
